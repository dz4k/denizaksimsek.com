<!doctype html>
<html lang="<%= it.lang ?? "en" %>">
<head>
<%~ await includeFile("header.html", it) %>
</head>
<body>
<nav class="container">
    <p><a href="/">&larr; <%= intl["Home"][lang] %> </a></p>
</nav>
<article class="container h-entry">
    <header>
        <% if ("title" in it) { %>
            <h1 class="p-name"><%= it.title %></h1>
        <% } %>
        <p>
            <% repeat(tags, (tag, loop) => { %>
                <a href="/tag/<%= tag %>"><data class="p-category" value="<% tag %>">
                    <%= intl[tag + " (tag)"][lang] %></data></a><%~ loop.sep(" &middot; ") %>
            <% }) %>

            <time class="dt-published" datetime="<%= filters.date(it.date, "ATOM") %>">
                <%~ filters.date(it.date, "M_DATE", it.lang) %></time>
            
            <%_ if ("last modified" in it) { _%>
                , <em><%= intl["last modified"][it.lang] %></em>
                <time class="dt-last-modified" datetime="<%= filters.date(it["last modified"], "ATOM") %>">
                    <%= filters.date(it["last modified"], "M_DATETIME", it.lang) %></time> 
            <% } %>
        </p>
        <% for (const prop of ["repost of", "like of"]) { %>
            <% if (prop in it) { %>
                <p>
                    <a class="u-<%= prop.replace(" ", "-") %>" href="<%= it[prop].url %>">
                        <%= it[prop].name %>
                    </a>
                </p>
            <% } %>
        <% } %>

        </dl>        
        <% if ("..." in it) { %>
            <p class="italic"><%~ it["..."] %></p>
        <% } %>
    </header>

    <% if ("bookmark of" in it) { %>
        <missing-card class="crowded" onclick="this.querySelector('a').click()">
            <p>
                &rarr;
                <a class="u-bookmark-of" href="<%= it["bookmark of"].url %>">
                    <%= it["bookmark of"].name %>
                </a>
            </p>
        </missing-card>
    <% } %>
    
    <div class="e-content">
        <%~ it.content %>
    </div>

    <% const backlinks = search.pages(`internalLinks*='${url}'`) %>
    <% if (backlinks.length > 0) { %>
        <footer class="missing-card">
            <h3 class="block-label">Backlinks</h3>
            <%~ comp.entryList({
                entries: backlinks,
                dates: false,
                lang
            }) %>
        </footer>
    <% } %>
    
    <% if (url in webmentions || "syndication" in it) { %>
        <footer class="missing-card">
            <% if ("syndication" in it) { %>
                <strong class="block-label"><%= intl["Elsewhere"][lang] %>:</strong> 
                    <p>
                        <% repeat(Object.keys(it.syndication), (syn, loop) => { %>
                            <a rel="syndication" href="<%= it.syndication[syn] %>">
                                <%= syn %></a><%= loop.sep(", ") %>
                        <% }) %>
                    </p>
            <% } %>

            <% if (url in webmentions) { %>
                    <% for (const prop of ["repost-of", "like-of"]) { %>
                        <% if (prop in webmentions[url]) { %>
                            <p class="list-of-links" style="margin-top: calc(2 * var(--gap));">
                                <strong class="block-label"><%= intl[prop + " (reflexive)"][lang] %>:</strong>
                                <% const wms = webmentions[url][prop] %>
                                <% repeat(wms, (wm, loop) => { %>
                                    <a href="<%= wm.url %>"><%= wm.author.name %></a><%= loop.sep(", ") %>
                                <% }) %>
                            </p>
                        <% } %>
                    <% }%>

                    <% if ("in-reply-to" in webmentions[url]) { %>
                        <% repeat(webmentions[url]["in-reply-to"], (wm, loop) => { %>
                            <article class="h-entry margin-block">
                                <% if (wm.author) { %>
                                    <b><a class="p-author h-card" href="<%= wm.author.url %>">
                                        <%= wm.author.name %></a></b> &middot;
                                <% } %>
                                <a href="<%= wm.url %>">
                                    <%= filters.date(wm.published ?? wm["wm-received"], "M_DATETIME", it.lang) %></a>
                                <div class="e-content">
                                    <%= wm.content.text %>
                                </div>
                            </article>
                        <% }) %>
                    <% } %>
            <% } %>
        </footer>
    <% } %>
</article>
<%~ await includeFile("footer.html", it) %>
</body>
